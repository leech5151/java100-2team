<meta charset="UTF-8">
<link href="../../myDesign/lost/lost.css" rel="stylesheet">
<link href="../../myDesign/lost/lost2.css" rel="stylesheet">
<link href="../../myDesign/lost/lost3.css" rel="stylesheet">

<div class="bal-mb-3">
    <div style="margin-top: 15%;text-align: left;">
    <h2>Lost</h2>
    <div>
    
<nav aria-label="Page navigation" style="position: relative; float: left; width: 100%;">
<button id="lostPrevBtn" class="btn btn-sm btn-light before-login" style="margin-left: 44%; color: blue;">이전</button>
<button id="lostNextBtn" class="btn btn-sm btn-light before-login" style="color: blue;">다음</button>
<button id="lostAddBtn" type="button" class="btn btn-danger btn-sm after-login">미아 등록</button>
<button id="lostPrevBtn" class="btn btn-sm btn-light after-login" style="margin-left: 35%; color: blue;">이전</button>
<button id="lostNextBtn" class="btn btn-sm btn-light after-login" style="color: blue;">다음</button>
</nav>
<br>
<br>
<br>
</div>
    <div id="lostList" class="bal-mb-3-list"></div>
    </div>
</div>
<script id="lostTemplate" type="text/x-handlebars-template">

{{#each list}}

<div class="bal-mb-3-data lostData" style="border: 1px; border-color: #808080;">
<figure class="snip1436">
{{#each files}}
<img src="../../download/{{filename}}" alt="{{filename}}" style="width:100%; height:100%;">
{{/each}}
<figcaption>
<h3 style="text-align: center;"> < 이름 : {{petName}} > </h3>
<ul style="margin-top: 1rem;">
    <li style="font-size: 20px;">특이사항 : {{character}}</>
    <li style="font-size: 20px;">분실장소 : {{lostLocation}}</>
    <li style="font-size: 20px;">분실일 : {{lostDate}}</li>
    <li style="font-size: 20px;">연락처 : {{registrant.tel}}</li>
</ul>
<button id="lostView{{lostNo}}" data-toggle="modal" data-target="#exampleModal" type="button" style="margin-left: 1rem; color: white;" class="btn btn-sm btn-dark after-login">&#x2795; 더 보기</button>
<button id="delete{{lostNo}}" type="button" style="margin-left: 4rem;" class="btn btn-sm btn-dark after-login">&#x2796; 삭제</button>
</figcaption>
</figure>
</a>
</div>

{{/each}}
</script>

<script src='../../node_modules/handlebars/dist/handlebars.min.js'></script>
<script src='../../node_modules/jquery/dist/jquery.js'></script>
<script src='../../node_modules/popper.js/dist/umd/popper.min.js'></script>
<script src='../../node_modules/bootstrap/dist/js/bootstrap.min.js'></script>
<script src='../../node_modules/sweetalert/dist/sweetalert.min.js'></script>
<script src="../../node_modules/sweetalert2/dist/sweetalert2.all.js"></script>

<script type="text/javascript">
var pageNo = 1,
    list = $('#lostList'),      
    lostTemplateSrc = $('#lostTemplate').html(),
    lostTemplateEngine = Handlebars.compile(lostTemplateSrc);
    

$.getJSON('../../json/auth/loginUser', (result) => {
    if (result.status == 'fail') {
        $('.after-login').css('display', 'none');
    }
    
    if (result.status == 'success') {
	    var member = result.member;
	    var currTel = member.tel;
    }
    
    var options = {};
    options.pn = pageNo;
    $.ajax('../../json/lost/list', {
        data: options,
        dataType: 'json',
        success: (result) => {
           list.append(lostTemplateEngine(result));

               $('button').click(function(e){
	            var id = e.target.getAttribute('id');
	            if ((id != '') && (id != null))  
	                var newId = '#' + id;

	            if (newId == '#lostAddBtn') {
			    	addModalStart();
			    } else if ((newId == '#lostPrevBtn')) {
	    			pageNo = pageCalculator(-1, result.lastPageNo)
			    	pageChange(pageNo, options)
			    } else if (newId == '#lostNextBtn') {
	    			pageNo = pageCalculator(1, result.lastPageNo)
			    	pageChange(pageNo, options)
			    } else if (newId.substring(0, 7) == '#delete') {
			    	
			    	$.getJSON('../../json/lost/' + newId.substring(7), (result) => {
			    		if(currTel==result.data.registrant.tel) {
					    	$.getJSON('../../json/delete/' + newId.substring(7));
			    		}
			    	});
			    } else if (newId.substring(0, 9) == '#lostView') {
		    		$.ajax('../../json/lost/' + newId.substring(9), {
		    	        dataType: 'json',
		    	        success: (result) => {
		    	           list.empty();
		    	        		   for (var file of result.data.files) {}	   
		    	           $('#lostList').html(
		    	        		   "<div class='bal-mb-3-data lostData' style='border: 1px; border-color: #808080; margin-left: 10rem;'>" + 
		    	        		   "<figure class='snip1283p'>" + 
		    	        		   "<img src='../../download/" + file.filename + "' alt='" + file.filename + "' style='width:100%; height:100%;'>" + 
		    	        		   "<figcaption>" + 
		    	        		   "<h3 style='text-align: center;'> < " + result.data.petName + " > </h3>" + 
		    	        		       
		    	        		       "<form id='fileForm2' enctype='multipart/form-data'>" + 
			    	        		       "이름 :           <input id='petName2' class='afterUpdate' type='text' name='petName' style='width: 20rem; margin-left: 6.5rem; background-color: black; color: white;' placeholder='" + result.data.petName + "'><br><br><br>" + 
			    	        		       "품종 :           <input id='breed2' class='afterUpdate' type='text' name='breed' style='width: 20rem; margin-left: 6.5rem; background-color: black; color: white;' placeholder='" + result.data.breed + "'><br><br><br>" + 
			    	        		       "분실장소 :       <input id='lostLocation2' class='afterUpdate' type='text' name='lostLocation' style='width: 20rem; margin-left: 4.5rem; background-color: black; color: white;' placeholder='" + result.data.lostLocation + "'><br><br><br>" + 
			    	        		       "분실일(" + result.data.lostDate + ") : <input id='lostDate2' class='afterUpdate' type='date' name='lostDate' style='width: 18.5rem; margin-left: 1rem; background-color: black; color: white;'><br><br><br>" + 
			    	        		       "특이사항 :       <input id='character2' class='afterUpdate' type='text' name='character' style='width: 20rem; margin-left: 4.5rem; background-color: black; color: white;' placeholder='" + result.data.character + "'><br><br><br>" + 
			    	        		       "사례금 :         <input id='reward2' class='afterUpdate' type='text' name='reward' style='width: 20rem; margin-left: 5.5rem; background-color: black; color: white;' placeholder='" + result.data.reward + "'><br><br><br>" + 
			    	        		       "알릴사항 : <input id='contents2' class='afterUpdate' type='text' name='contents' style='width: 20rem; margin-left: 4.5rem; background-color: black; color: white;' placeholder='" + result.data.contents + "'><br><br>" + 
			    	        		       "사진 :           <input id='file2' class='afterUpdate' type='file' name='file' style='width: 20rem; color: black; color: white;'>" + 
		    	        		       "</form>" + 
		    	        		       
		    	        		   "<button id='lostUpdateBtn' type='button' style='margin-left: 1rem; color: white;' class='btn btn-sm btn-dark after-login'>수정</button>" + 
		    	        		   "<button id='return' type='button' style='margin-left: 1rem; color: white;' class='btn btn-sm btn-dark'>전체조회</button>" + 
		    	        		   "</figcaption>" + 
		    	        		   "</figure>" + 
		    	        		   "</a>" + 
		    	        		   "</div>");
		    	           
		    	           $('#lostUpdateBtn').click(() => {
		    	        	    var formData = new FormData($("#fileForm2")[0]);
		    	        	    $.ajax('../../json/lost/update', {
		    	        	        data: formData,
		    	        	        dataType: 'json',
		    	        	        method: 'POST',
		    	        	        processData : false,
		    	        	        contentType : false,
		    	        	        success: (result) => {
		    	        	        location.href = "../main/home.html#lost";
		    	        	        },
		    	        	        error: (jqXHR, textStatus, errorThrown) => {
		    	        	            swal("수정 실패!", "정보를 확인 해보세요!", "error");
		    	        	            /* window.alert('서버 실행 오류!'); */
		    	        	        }
		    	        	    });
		    	        	});
	    	        		   }
	    	        });
			    }
		    });
       }
    });
});

function pageCalculator(n, lastPageNo) {
   pageNo += n;
   if (pageNo > lastPageNo) {
	   pageNo = 1;
   } else if (pageNo == 0) {
	   pageNo = lastPageNo;
   }
   return pageNo;
}

function pageChange(pageNo, options) {

	$('.lostData').remove();
	options.pn = pageNo;
    $.ajax('../../json/lost/list', {
        data: options,
        dataType: 'json',
        success: (result) => {
           list.append(lostTemplateEngine(result));
           location.href = "../main/home.html#lost";
       }
    });
}

function addModalStart() {
	var lostFormAddModal = $('#lostFormAddModal');
	var lostFormAddModalContent = $('#lostFormAddModal .modal-content');
    event.preventDefault();
    event.stopPropagation();
    lostFormAddModalContent.load('../lost/lostForm.html', () => {
    	lostFormAddModal.modal();
    });
}

</script>
