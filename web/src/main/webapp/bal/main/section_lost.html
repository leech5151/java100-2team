<meta charset="UTF-8">
<link href="../../myDesign/lost/lost.css" rel="stylesheet">
<link href="../../myDesign/lost/lost2.css" rel="stylesheet">
<link href="../../myDesign/lost/lost3.css" rel="stylesheet">

<div class="bal-mb-3">
    <div style="margin-top: 15%;text-align: left;">
    <h2>Lost</h2>
    <div>
    
<nav aria-label="Page navigation" style="position: relative; float: left; width: 100%;">
<button id="lostPrevBtn" class="btn btn-sm btn-light before-login" style="margin-left: 44%; color: blue;">이전</button>
<button id="lostNextBtn" class="btn btn-sm btn-light before-login" style="color: blue;">다음</button>
<button id="lostAddBtn" type="button" class="btn btn-danger btn-sm after-login">미아 등록</button>
<button id="lostPrevBtn" class="btn btn-sm btn-light after-login" style="margin-left: 35%; color: blue;">이전</button>
<button id="lostNextBtn" class="btn btn-sm btn-light after-login" style="color: blue;">다음</button>
</nav>
<br>
<br>
<br>
</div>
    <div id="lostList" class="bal-mb-3-list"></div>
    </div>
</div>
<script id="lostTemplate" type="text/x-handlebars-template">

{{#each list}}

<div class="bal-mb-3-data lostData" style="border: 1px; border-color: #808080;">
<figure class="snip1436">
{{#each files}}
<img src="../../download/{{filename}}" alt="{{filename}}" style="width:100%; height:100%;">
{{/each}}
<figcaption>
<h3 style="text-align: center;"> < 이름 : {{petName}} > </h3>
<ul style="margin-top: 1rem;">
    <li style="font-size: 20px;">특이사항 : {{character}}</>
    <li style="font-size: 20px;">분실장소 : {{lostLocation}}</>
    <li style="font-size: 20px;">분실일 : {{lostDate}}</li>
    <li style="font-size: 20px;">연락처 : {{registrant.tel}}</li>
</ul>
<button id="lostView{{lostNo}}" data-toggle="modal" data-target="#exampleModal" type="button" style="margin-left: 1rem; color: white;" class="btn btn-sm btn-dark after-login">&#x2795; 더 보기</button>
<button id="lostDeleteBtn{{lostNo}}" type="button" style="margin-left: 4rem;" class="btn btn-sm btn-dark after-login lostDeleteBtn">&#x2796; 삭제</button>
</figcaption>
</figure>
</a>
</div>

{{/each}}
</script>

<script src='../../node_modules/handlebars/dist/handlebars.min.js'></script>
<script src='../../node_modules/jquery/dist/jquery.js'></script>
<script src='../../node_modules/popper.js/dist/umd/popper.min.js'></script>
<script src='../../node_modules/bootstrap/dist/js/bootstrap.min.js'></script>
<script src='../../node_modules/sweetalert/dist/sweetalert.min.js'></script>
<script src="../../node_modules/sweetalert2/dist/sweetalert2.all.js"></script>

<script type="text/javascript">
var pageNo = 1,
    list = $('#lostList'),      
    lostTemplateSrc = $('#lostTemplate').html(),
    lostTemplateEngine = Handlebars.compile(lostTemplateSrc);
    

$.getJSON('../../json/auth/loginUser', (result) => {
    if (result.status == 'fail') {
        $('.after-login').css('display', 'none');
    }
    
    if (result.status == 'success') {
	    var member = result.member;
	    var currTel = member.tel;
    }
    
    var options = {};
    options.pn = pageNo;
    $.ajax('../../json/lost/list', {
        data: options,
        dataType: 'json',
        success: (result) => {
           list.append(lostTemplateEngine(result));

           for (var data of result.list) {
        	   if (currTel != data.registrant.tel) {
        		   $('.lostDeleteBtn').css('display', 'none');
        	   }
           }
            $('button').click(function(e){
	          var id = e.target.getAttribute('id');
	          if ((id != '') && (id != null))  
	              var newId = '#' + id;
	          if (newId == '#lostAddBtn') {
	    	  addModalStart();
			  } else if ((newId == '#lostPrevBtn')) {
		  		pageNo = pageCalculator(-1, result.lastPageNo)
			    pageChange(pageNo, options)
			  } else if (newId == '#lostNextBtn') {
		  		pageNo = pageCalculator(1, result.lastPageNo)
			   	pageChange(pageNo, options)
			  } else if (newId.substring(0, 14) == '#lostDeleteBtn') {
				  $.getJSON('../../json/lost/' + newId.substring(14), (result) => {
		    		if(currTel==result.data.registrant.tel) {
				    	$.ajax('../../json/lost/delete/', {
				    		data: {
				    			no: newId.substring(14)
				    		},
				            dataType: 'json',
				            success: (result) => {
				            	location.href = '../main/home.html';
				            }
				    	});
		    		} else {
		    			swal('삭제불가', '삭제할 수 없습니다.', 'error')
		    		}
		    	});
		    } else if (newId.substring(0, 9) == '#lostView') {
		   		$.ajax('../../json/lost/' + newId.substring(9), {
		   	        dataType: 'json',
		   	        success: (result) => {
		   	           list.empty();
   	        		   for (var file of result.data.files) {}	   
		   	           $('#lostList').html(
	   	        		   "<div class='lostViewUpdate'>" + 
		      		       "<form id='fileForm2' enctype='multipart/form-data'>" + 
		      		       "<p id='lostPetName'> < <input id='petName' class='afterUpdate' type='text' name='petName' style='background-color: black; color: white;' placeholder='" + result.data.petName + "'> > </p><br>" + 
		      		       "<img id='lostPetPhoto2' class='' src= '../../download/" + file.filename + "' alt=''>" + 
		      		       "<div style='float: left;'>" + 
		      		       "<p>" + 
		      		       "<b>품종 :       </b><input id='breed' class='afterUpdate' type='text' name='breed' style='background-color: black; color: white;' placeholder='" + result.data.breed + "'><br>" + 
		      		       "<b>분실장소 :   </b><input id='lostLocation' class='afterUpdate' type='text' name='lostLocation' style='background-color: black; color: white;' placeholder='" + result.data.lostLocation + "'><br>" + 
		      		       "<b>분실일 :     </b><input type='date' id='lostDate' name='lostDate' value='" + result.data.lostDate + "' class='calendar hasDatepicker' style='width: 9rem; background-color: black; background-image:url(../../images/button/calendar48_2.png); background-repeat: no-repeat; background-position: right; background-size: 40px'><br>" + 
		      		       "<b>사진 :       </b><input id='file' class='afterUpdate' type='file' name='file' style='width: 5rem; black; color: white;'>" + 
		      		       "</p></div>" +
		      		       "<div style='float: left; margin-left: -1rem;'>" + 
		      		       "<p>" + 
		      		       "<b>특이사항 :   </b><input id='character' class='afterUpdate' type='text' name='character' style='width: ; background-color: black; color: white;' placeholder='" + result.data.character + "'><br>" + 
		      		       "<b>사례금 :     </b><input id='reward' class='afterUpdate' type='text' name='reward' style='background-color: black; color: white;' placeholder='" + result.data.reward + " 원'><br>" + 
		      		       "<b>알릴사항 :   </b><input id='contents' class='afterUpdate' type='text' name='contents' style='background-color: black; color: white;' placeholder='" + result.data.contents + "'><br>" + 
	   	        		   "<button id='lostUpdateBtn' type='button' style='margin-left: 0rem; color: white;' class='btn btn-sm btn-dark after-login'>수정</button>" + 
	   	        		   "<button id='lostReturnBtn' type='button' style='margin-left: 1rem; color: white;' class='btn btn-sm btn-dark'>전체조회</button>" + 
		      		       "</p></div>" +
		      		       "</form>" + 
		      		       "</div>"
   	        		   );
		   	           
						$(function() {
						  $("#file").on('change', function(){
						      readURL(this);
						  });
						});
						
						function readURL(input) {
						    if (input.files && input.files[0]) {
						    var reader = new FileReader();
						    reader.onload = function (e) {
						            $('#lostPetPhoto2').attr('src', e.target.result);
						    }
						      reader.readAsDataURL(input.files[0]);
						    } 
						}
		   	           
		   	           $('#lostUpdateBtn').click(() => {
		   	        	   $(document).ready(() => {
		   	        	    var formData = new FormData($("#fileForm2")[0]);
		   	        	    formData.append('lostNo', result.data.lostNo)
		   	        	    $.ajax('../../json/lost/update', {
		   	        	        data: formData,
		   	        	        dataType: 'json',
		   	        	        method: 'POST',
		   	        	        processData : false,
		   	        	        contentType : false,
		   	        	        success: (result) => {
		   	        	        location.href = "../main/home.html";
		   	        	        },
		   	        	        error: (jqXHR, textStatus, errorThrown) => {
		   	        	            swal("수정 실패!", "정보를 확인 해보세요!", "error");
		   	        	        }
		   	        	    });
		   	           });
		   	        	});
		   	           
		   	           $('#lostReturnBtn').click(() => {
		   	        	   $(document).ready(() => {
		   	        	    $.ajax('../../json/lost/list', {
		   	        	        dataType: 'json',
		   	        	        method: 'POST',
		   	        	        processData : false,
		   	        	        contentType : false,
		   	        	        success: (result) => {
		   	        	        location.href = "../main/home.html";
		   	        	        },
		   	        	        error: (jqXHR, textStatus, errorThrown) => {
		   	        	            swal("이동 실패!", "잠시 후 다시 시도해보세요!", "error");
		   	        	        }
		   	        	    });
		   	           });
		   	        	});
 	        		   }
		  	        });
		   	    }
		   });
       }
    });
});

function pageCalculator(n, lastPageNo) {
   pageNo += n;
   if (pageNo > lastPageNo) {
	   pageNo = 1;
   } else if (pageNo == 0) {
	   pageNo = lastPageNo;
   }
   return pageNo;
}

function pageChange(pageNo, options) {

	$('.lostData').remove();
	options.pn = pageNo;
    $.ajax('../../json/lost/list', {
        data: options,
        dataType: 'json',
        success: (result) => {
           list.append(lostTemplateEngine(result));
           location.href = "../main/home.html#lost";
       }
    });
}

function addModalStart() {
	var lostFormAddModal = $('#lostFormAddModal');
	var lostFormAddModalContent = $('#lostFormAddModal .modal-content');
    event.preventDefault();
    event.stopPropagation();
    lostFormAddModalContent.load('../lost/lostForm.html', () => {
    	lostFormAddModal.modal();
    });
}

</script>
